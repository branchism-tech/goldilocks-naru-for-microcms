<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Embed Image Renderer</title>
    <style>
      :root {
        --fg: #111;
        --muted: #666;
        --bg: #fff;
        --border: #e5e7eb;
        --radius: 12px;
      }
      body {
        margin: 0;
        padding: 16px;
        background: var(--bg);
        color: var(--fg);
        font: 14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP,
          Arial, sans-serif;
      }
      .wrap {
        max-width: 960px;
        margin: 0 auto;
      }
      figure {
        margin: 0;
        display: grid;
        gap: 8px;
      }
      .imgBox {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      img {
        max-width: 100%;
        height: auto;
        display: block;
        border-radius: var(--radius);
        border: 1px solid var(--border);
      }
      figcaption {
        color: var(--muted);
        font-size: 13px;
      }
      .hint {
        color: var(--muted);
        font-size: 12px;
      }
      .err {
        color: #b00020;
        font-weight: 600;
      }
      a.inline {
        display: inline-block;
        line-height: 0;
        border-radius: var(--radius);
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <figure>
        <div class="imgBox" id="imgBox"></div>
        <figcaption id="cap" hidden></figcaption>
      </figure>
      <p class="hint" id="hint"></p>
    </div>

    <script>
      function getParam(names, search) {
        const sp = new URLSearchParams(search);
        for (const n of names) {
          if (sp.has(n)) return sp.get(n);
        }
        return null;
      }

      function toInt(v) {
        if (v == null) return null;
        const n = parseInt(String(v), 10);
        return Number.isFinite(n) && n > 0 ? n : null;
      }

      function isTrue(v) {
        if (!v) return false;
        return ["1", "true", "yes", "on"].includes(String(v).toLowerCase());
      }

      // Accept: http/https only（リンク用）
      function safeUrl(u) {
        try {
          const url = new URL(u);
          if (["http:", "https:"].includes(url.protocol)) return url.toString();
          return null;
        } catch {
          return null;
        }
      }

      (function main() {
        const search = location.search;

        // Parameter names
        // imgurl は FILE_ID のみを想定
        const fileIdRaw = getParam(["imgurl", "fileid", "id"], search); // required
        const width = toInt(getParam(["width", "w"], search));
        const height = toInt(getParam(["height", "h"], search));
        const alt = getParam(["alt", "a", "代替テキスト"], search) || "";
        const caption = getParam(["cap", "caption", "説明", "c"], search) || "";
        const linkRaw = getParam(["link", "href", "l"], search);
        const newTab = isTrue(getParam(["tab", "blank", "newtab"], search)); // default false

        const hint = document.getElementById("hint");
        const imgBox = document.getElementById("imgBox");
        const cap = document.getElementById("cap");

        if (!fileIdRaw) {
          const example = `${location.origin}${location.pathname}?imgurl=FILE_ID&width=800&height=450&alt=%E8%AA%AC%E6%98%8E&cap=%E3%82%AD%E3%83%A3%E3%83%97%E3%82%B7%E3%83%A7%E3%83%B3&link=https%3A%2F%2Fexample.com&tab=true`;
          hint.innerHTML = `imgurl (GoogleドライブのファイルID) は必須です。<br/>使い方: <code>?imgurl=FILE_ID&width=...&height=...&alt=...&cap=...&link=...&tab=true</code><br/>例: <a href="${example}">パラメータ例</a>`;
          hint.classList.remove("err");
          return;
        }

        const fileId = fileIdRaw.trim();

        // 簡易バリデーション（英数字 + _ - / 10文字以上くらい）
        if (!/^[a-zA-Z0-9_-]{10,}$/.test(fileId)) {
          hint.textContent =
            "imgurl (FILE_ID) が不正です。GoogleドライブのファイルIDのみ指定してください。";
          hint.classList.add("err");
          return;
        }

        // ★ここで最終的な画像URLを組み立てる★
        const src = `https://lh3.googleusercontent.com/d/${fileId}`;

        const img = new Image();
        img.decoding = "async";
        img.loading = "lazy";
        img.alt = alt;
        img.src = src;

        // width / height が指定されていない場合は属性を付けない → 実サイズで表示
        if (width) img.width = width;
        if (height) img.height = height;

        let node = img;
        const link = linkRaw ? safeUrl(linkRaw) : null;
        if (link) {
          const a = document.createElement("a");
          a.className = "inline";
          a.href = link;
          if (newTab) {
            a.target = "_blank";
            a.rel = "noopener noreferrer";
          }
          a.appendChild(img);
          node = a;
        }

        imgBox.innerHTML = "";
        imgBox.appendChild(node);

        if (caption) {
          cap.textContent = caption;
          cap.hidden = false;
        }

        // debug log
        const sp = new URLSearchParams();
        sp.set("fileId", fileId);
        sp.set("src", src);
        if (width) sp.set("width", String(width));
        if (height) sp.set("height", String(height));
        if (alt) sp.set("alt", alt);
        if (caption) sp.set("cap", caption);
        if (link) sp.set("link", link);
        if (newTab) sp.set("tab", "true");
        console.log("params", Object.fromEntries(sp.entries()));
      })();
    </script>
  </body>
</html>
