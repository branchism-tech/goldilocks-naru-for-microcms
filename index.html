<!DOCTYPE html>
<meta charset="utf-8" />
<title>Drive Image Preview (microCMS extension)</title>
<style>
  body {
    font: 14px/1.6 system-ui, sans-serif;
    margin: 12px;
    overflow: hidden; /* スクロールバー抑止 */
  }
  .row {
    display: grid;
    gap: 8px;
  }
  input[type="text"] {
    padding: 8px;
    width: 100%;
    box-sizing: border-box;
  }
  img {
    width: 25%;
    height: auto;
    display: block;
    border: 1px solid #ddd;
    border-radius: 6px;
  }
  .hint {
    color: #666;
    font-size: 12px;
  }
</style>

<div class="row">
  <label>画像URL（https://lh3.googleusercontent.com/d/...）</label>
  <input
    id="url"
    type="text"
    placeholder="https://lh3.googleusercontent.com/d/xxxxxxxx"
  />
  <div class="hint">
    Drive公開リンクを
    <code>https://lh3.googleusercontent.com/d/FILE_ID</code> 形式にして入力
  </div>
  <img id="preview" alt="preview" />
</div>

<script>
  let iframeId = null;
  const origin = location !== window.parent.location ? document.referrer : "*";

  const $url = document.getElementById("url");
  const $img = document.getElementById("preview");

  function resizeToImage() {
    const rect = document.body.getBoundingClientRect();
    window.parent.postMessage(
      {
        id: iframeId,
        action: "MICROCMS_UPDATE_STYLE",
        message: { height: rect.height + 20, width: "100%" },
      },
      origin
    );
  }

  function postValue(val) {
    window.parent.postMessage(
      {
        id: iframeId,
        action: "MICROCMS_POST_DATA",
        message: { data: val },
      },
      origin
    );
  }

  function render(val) {
    $url.value = val || "";

    if (!val) {
      $img.style.display = "none";
      $img.removeAttribute("src");
      resizeToImage();
      return;
    }

    $img.style.display = "block";
    $img.src = val;

    $img.onload = () => resizeToImage();
    resizeToImage();
  }

  window.addEventListener("message", (e) => {
    if (!e.data || !e.data.action) return;

    if (e.data.action === "MICROCMS_GET_DEFAULT_DATA") {
      iframeId = e.data.id;
      const current = (e.data.message && e.data.message.data) || "";
      render(current);
    }
  });

  $url.addEventListener("input", () => {
    const val = $url.value.trim();
    render(val);
    postValue(val);
  });
</script>
